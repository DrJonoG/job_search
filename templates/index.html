{% extends "base.html" %}
{% block title %}Search | job_search{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                <i class="bi bi-briefcase"></i>
            </div>
            <div>
                <div class="stat-value" id="statTotal">{{ stats.total }}</div>
                <div class="stat-label">Total Jobs Saved</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon bg-success bg-opacity-10 text-success">
                <i class="bi bi-globe2"></i>
            </div>
            <div>
                <div class="stat-value">{{ stats.remote_count }}</div>
                <div class="stat-label">Remote Positions</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon bg-info bg-opacity-10 text-info">
                <i class="bi bi-building"></i>
            </div>
            <div>
                <div class="stat-value">{{ stats.sources | length }}</div>
                <div class="stat-label">Active Sources</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                <i class="bi bi-lightning"></i>
            </div>
            <div>
                <div class="stat-value">{{ sources | selectattr('available') | list | length }}</div>
                <div class="stat-label">Sources Available</div>
            </div>
        </div>
    </div>
</div>

<!-- Saved Searches Row -->
<div class="saved-searches-row mb-3" id="savedSearchesRow" style="display:none;">
    <div class="d-flex align-items-center gap-2 mb-2">
        <h6 class="fw-bold mb-0 text-muted small text-uppercase" style="letter-spacing:0.08em; font-size:0.7rem;">
            <i class="bi bi-bookmark-star me-1"></i>Saved Searches
        </h6>
    </div>
    <div class="saved-searches-scroll" id="savedSearchesList"></div>
</div>

<div class="row g-4">
    <!-- Search Form -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pt-4 px-4">
                <h4 class="fw-bold mb-1"><i class="bi bi-search me-2 text-primary"></i>New Job Search</h4>
                <p class="text-muted small mb-0">Search across multiple job boards simultaneously. Results are saved and deduplicated automatically.</p>
            </div>
            <div class="card-body px-4 pb-4">
                <form id="searchForm">
                    <!-- Keywords -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold d-flex align-items-center gap-1">
                            Job Titles / Keywords <span class="badge badge-optional">Optional</span>
                            <button type="button" class="btn btn-link btn-sm p-0 text-secondary keywords-help-trigger"
                                id="keywordsHelpTrigger" aria-label="How keywords and matching work">
                                <i class="bi bi-question-circle" aria-hidden="true"></i>
                            </button>
                        </label>
                        <textarea class="form-control" id="keywords" rows="3"
                            placeholder="Leave empty to search all jobs, or enter keywords separated by commas, e.g.&#10;data analyst, machine learning engineer, python developer">{{ default_keywords | join(', ') }}</textarea>
                        <div class="form-text">Comma-separated keywords. Empty = broad search across all jobs.</div>
                        <!-- Popover content (injected by JS) -->
                        <div id="keywordsHelpContent" class="d-none">
                            <div class="keywords-help-popover">
                                <p class="mb-2"><strong>How to enter terms</strong></p>
                                <ul class="small mb-3 ps-3">
                                    <li>Use <strong>commas</strong> to separate different job titles or phrases (e.g. <code>data analyst, machine learning engineer</code>).</li>
                                    <li>Leave the field <strong>empty</strong> to run a broad search across all jobs.</li>
                                    <li>Each phrase is sent to the selected sources; results are combined and deduplicated.</li>
                                </ul>
                                <p class="mb-2"><strong>How matching works</strong></p>
                                <ul class="small mb-0 ps-3">
                                    <li>A job is kept if it contains your <strong>full phrase</strong> (e.g. &ldquo;machine learning engineer&rdquo;) in the title or description.</li>
                                    <li>We also match when a <strong>multi-word prefix</strong> of your phrase appears: e.g. a job that says &ldquo;machine learning&rdquo; will still match the keyword &ldquo;machine learning engineer&rdquo;.</li>
                                    <li>API sources (Indeed, LinkedIn, Reed, etc.) use their own search; we send your phrases as queries. Scraped sources (e.g. GOV.UK, Greenhouse) apply the rules above to filter results.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <!-- Location -->
                        <div class="col-md-6" id="locationGroup">
                            <label class="form-label fw-semibold">Location <span class="badge badge-optional">Optional</span></label>
                            <input type="text" class="form-control" id="location"
                                placeholder="e.g. London, New York" title="Disabled when Work type is Remote">
                            <div class="form-text text-muted" id="locationHint">City, region, or country</div>
                        </div>

                        <!-- Remote -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Work Type</label>
                            <select class="form-select" id="remote">
                                {% for opt in remote_options %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <!-- Job Type -->
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Job Type <span class="badge badge-optional">Optional</span></label>
                            <select class="form-select" id="jobType">
                                <option value="">Any</option>
                                {% for jt in job_types %}
                                <option value="{{ jt }}">{{ jt }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Experience -->
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Experience Level <span class="badge badge-optional">Optional</span></label>
                            <select class="form-select" id="experienceLevel">
                                <option value="">Any</option>
                                {% for lvl in experience_levels %}
                                <option value="{{ lvl }}">{{ lvl }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Min Salary -->
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Minimum Salary <span class="badge badge-optional">Optional</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                <input type="number" class="form-control" id="salaryMin"
                                    placeholder="e.g. 50000" min="0" step="1000">
                            </div>
                        </div>
                    </div>

                    <!-- Max Results & Posted in last -->
                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Max Results Per Source <span class="badge badge-optional">Optional</span></label>
                            <input type="range" class="form-range" id="maxResults" min="25" max="1000" step="25" value="200">
                            <div class="form-text">Up to <strong id="maxResultsVal">200</strong> results per source</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Posted in last <span class="badge badge-optional">Optional</span></label>
                            <select class="form-select" id="postedInLastDays">
                                <option value="">Any</option>
                                <option value="1">1 day</option>
                                <option value="3">3 days</option>
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                                <option value="30">30 days</option>
                            </select>
                            <div class="form-text">Only fetch jobs posted in this window. Supported by JobSpy/LinkedIn; others may ignore.</div>
                        </div>
                    </div>

                    <!-- Sources -->
                    <div class="mt-4 sources-section">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                            <label class="form-label fw-semibold mb-0">Sources <span class="badge badge-required">Required</span></label>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllSources">
                                    <i class="bi bi-check2-square me-1"></i> Select all
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="unselectAllSources">
                                    <i class="bi bi-square me-1"></i> Unselect all
                                </button>
                            </div>
                        </div>
                        <div class="sources-grid" id="sourcesGrid">
                            {% for src in sources %}
                            <label class="source-chip {% if not src.available %}source-chip-disabled{% endif %}" for="src_{{ src.name | replace(' ', '_') }}">
                                <input class="form-check-input source-checkbox" type="checkbox" id="src_{{ src.name | replace(' ', '_') }}"
                                    value="{{ src.name }}"
                                    {% if src.available %}checked{% else %}disabled{% endif %}>
                                <span class="source-chip-label">{{ src.name }}</span>
                                {% if src.free %}
                                    <span class="source-chip-badge source-chip-badge-free">Free</span>
                                {% elif not src.available %}
                                    <span class="source-chip-badge source-chip-badge-locked">Key needed</span>
                                {% else %}
                                    <span class="source-chip-badge source-chip-badge-configured">API</span>
                                {% endif %}
                            </label>
                            {% endfor %}
                        </div>
                        <div class="form-text mt-2" id="sourcesCount">Select at least one source to enable search.</div>
                    </div>

                    <!-- Submit -->
                    <div class="mt-4 d-flex flex-wrap gap-2">
                        <button type="submit" class="btn btn-search btn-lg px-4" id="searchBtn" disabled>
                            <i class="bi bi-search me-2"></i> Start Search
                        </button>
                        <button type="button" class="btn btn-outline-professional btn-lg px-4" id="saveSearchBtn" title="Save current search parameters">
                            <i class="bi bi-bookmark-plus me-2"></i> Save Search
                        </button>
                        <a href="/jobs" class="btn btn-outline-professional btn-lg px-4">
                            <i class="bi bi-collection me-2"></i> Browse Job Board
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Full-screen search overlay (blocking) -->
    <div class="search-overlay" id="searchOverlay" aria-hidden="true" style="display: none;">
        <div class="search-overlay-backdrop"></div>
        <div class="search-overlay-content">
            <div class="search-overlay-card" id="searchOverlayCard">
                <!-- Running state -->
                <div id="searchOverlayRunning">
                    <div class="search-overlay-icon">
                        <i class="bi bi-search spin" aria-hidden="true"></i>
                    </div>
                    <h4 class="search-overlay-title">Searching job boards</h4>
                    <p class="search-overlay-subtitle text-muted" id="searchOverlaySubtitle">Starting...</p>
                    <div class="progress search-overlay-progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="search-overlay-details" id="progressDetails"></div>
                    <button type="button" class="btn btn-outline-secondary btn-lg mt-3" id="searchOverlayCancel">
                        <i class="bi bi-x-lg me-2"></i> Cancel search
                    </button>
                </div>
                <!-- Done state (complete or cancelled) -->
                <div id="searchOverlayDone" style="display: none;">
                    <div class="search-overlay-icon search-overlay-icon-done" id="searchOverlayDoneIcon"></div>
                    <h4 class="search-overlay-title" id="searchOverlayDoneTitle">Search complete</h4>
                    <div class="search-overlay-summary" id="searchOverlaySummary"></div>
                    <div class="d-flex flex-wrap gap-2 justify-content-center mt-4">
                        <a href="/jobs" class="btn btn-primary btn-lg" id="searchOverlayBrowse">
                            <i class="bi bi-collection me-2"></i> Browse Job Board
                        </a>
                        <button type="button" class="btn btn-outline-secondary btn-lg" id="searchOverlayClose">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right column: How It Works & Source Status -->
    <div class="col-lg-4">
        <!-- Source Status -->
        <div class="card border-0 shadow-sm mt-0">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-plug me-2 text-primary"></i>Source Status</h5>
                <div class="d-flex flex-column gap-2">
                    {% for src in sources %}
                    <div class="d-flex justify-content-between align-items-center">
                        <span>{{ src.name }}</span>
                        {% if src.available %}
                            <span class="badge bg-success"><i class="bi bi-check-lg"></i> Ready</span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-lock"></i> API Key Required</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
