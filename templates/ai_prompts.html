{% extends "base.html" %}
{% block title %}AI Prompts | job_search{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
    <div>
        <h3 class="fw-bold mb-1"><i class="bi bi-robot me-2 text-info"></i>AI Prompts</h3>
        <p class="text-muted mb-0">
            <span id="totalPrompts">{{ stats.ai_prompts_count }}</span> prompt configuration{{ 's' if stats.ai_prompts_count != 1 else '' }} saved
        </p>
    </div>
    <button class="btn btn-primary btn-sm" id="newPromptBtn">
        <i class="bi bi-plus-lg me-1"></i> New Prompt
    </button>
</div>

<!-- ── Analysis Queue ─────────────────────────────────────────── -->
<div id="queueSection" style="display:none;" class="mb-4">
    <h5 class="fw-semibold mb-3">
        <i class="bi bi-list-task me-2 text-info"></i>Analysis Queue
        <span id="queueTotalBadge" class="badge bg-secondary ms-2 fw-normal fs-6"></span>
    </h5>

    <!-- Currently running -->
    <div id="queueRunningRow" class="d-flex align-items-center justify-content-between
         p-3 mb-2 rounded border border-info bg-opacity-10" style="display:none;">
        <div class="d-flex align-items-center gap-3">
            <div class="spinner-border spinner-border-sm text-info flex-shrink-0" role="status"></div>
            <div>
                <div class="fw-semibold" id="queueRunningTitle"></div>
                <small class="text-muted">
                    <span class="badge bg-info text-dark font-monospace" id="queueRunningModel"></span>
                    <span class="ms-1" id="queueRunningPrompt"></span>
                </small>
            </div>
        </div>
        <button class="btn btn-sm btn-outline-danger flex-shrink-0"
                onclick="AIQueue.cancel()" title="Cancel this analysis">
            <i class="bi bi-x-circle me-1"></i>Cancel
        </button>
    </div>

    <!-- Queued items (drag-to-reorder) -->
    <div id="queueItemsList">
        <!-- Populated by renderQueue() -->
    </div>
</div>

<!-- Info banner -->
<div class="alert alert-info d-flex align-items-start gap-2 mb-4" role="alert">
    <i class="bi bi-info-circle-fill flex-shrink-0 mt-1"></i>
    <div>
        <strong>What is an AI Prompt?</strong> An AI Prompt bundles your CV, a personal summary, your job
        preferences, and any extra context into a reusable configuration. When you later run an AI analysis
        against a job listing, this configuration is combined with the job description and sent to your local
        Ollama model. Mark one prompt as <strong>Active</strong> to use it as the default for new analyses.
    </div>
</div>

<!-- Loading -->
<div id="promptsLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="text-muted mt-2">Loading prompts...</p>
</div>

<!-- Empty State -->
<div id="promptsEmpty" class="text-center py-5" style="display:none;">
    <i class="bi bi-robot display-1 text-muted"></i>
    <h4 class="mt-3 text-muted">No AI prompts yet</h4>
    <p class="text-muted">Create your first prompt by pasting in your CV and telling the AI what you're looking for.</p>
    <button class="btn btn-primary mt-2" onclick="openPromptEditor()">
        <i class="bi bi-plus-lg me-1"></i> Create Prompt
    </button>
</div>

<!-- Prompts List -->
<div id="promptsList" class="row g-3"></div>

<!-- ── Prompt Editor Modal ───────────────────────────────────── -->
<div class="modal fade" id="promptEditorModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <div>
                    <h5 class="modal-title fw-bold" id="promptEditorTitle">New AI Prompt</h5>
                    <p class="text-muted small mb-0">Fill in as much detail as possible — the richer the context, the better the analysis.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-3">

                <!-- Title + Model + Active toggle -->
                <div class="row g-3 mb-3">
                    <div class="col-12 col-md-5">
                        <label for="promptTitle" class="form-label fw-semibold">
                            Prompt Name <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="promptTitle"
                               placeholder="e.g. Data Analyst – Senior roles 2025">
                    </div>
                    <div class="col-12 col-md-4">
                        <label for="promptModel" class="form-label fw-semibold">
                            <i class="bi bi-cpu me-1 text-info"></i>Ollama Model <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <select class="form-select" id="promptModel">
                                <option value="" disabled selected>Loading models…</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" id="refreshModelsBtn"
                                    onclick="loadOllamaModels(true)" title="Refresh model list">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div id="modelFetchStatus" class="form-text"></div>
                    </div>
                    <div class="col-12 col-md-3 d-flex align-items-end">
                        <div class="form-check form-switch ms-1 mb-2">
                            <input class="form-check-input" type="checkbox" id="promptIsActive" role="switch">
                            <label class="form-check-label fw-semibold" for="promptIsActive">
                                Set as Active
                            </label>
                            <div class="form-text">Used by default for new analyses.</div>
                        </div>
                    </div>
                </div>

                <!-- CV -->
                <div class="mb-3">
                    <label for="promptCV" class="form-label fw-semibold">
                        <i class="bi bi-file-person me-1 text-primary"></i> CV / Résumé
                        <span class="text-muted fw-normal small ms-1">(plain text — paste directly from your CV)</span>
                    </label>
                    <textarea class="form-control font-monospace" id="promptCV" rows="12"
                              placeholder="Paste your full CV or résumé here as plain text. Include your work history, education, and skills sections."></textarea>
                    <div class="d-flex justify-content-between mt-1">
                        <div class="form-text">The AI uses this to compare your background against the job requirements.</div>
                        <span class="form-text" id="cvCharCount">0 chars</span>
                    </div>
                </div>

                <!-- About Me -->
                <div class="mb-3">
                    <label for="promptAboutMe" class="form-label fw-semibold">
                        <i class="bi bi-person-circle me-1 text-success"></i> About Me
                        <span class="text-muted fw-normal small ms-1">(optional)</span>
                    </label>
                    <textarea class="form-control" id="promptAboutMe" rows="4"
                              placeholder="A brief summary in your own words. E.g. 'I am a data analyst with 5 years of experience in Python and SQL, transitioning into ML engineering. I enjoy building data pipelines and am comfortable with cloud environments.'"></textarea>
                    <div class="form-text">A personal summary that adds context beyond your CV — useful for tone and career goals.</div>
                </div>

                <!-- Preferences -->
                <div class="mb-3">
                    <label for="promptPreferences" class="form-label fw-semibold">
                        <i class="bi bi-sliders me-1 text-warning"></i> What I'm Looking For
                        <span class="text-muted fw-normal small ms-1">(optional)</span>
                    </label>
                    <textarea class="form-control" id="promptPreferences" rows="5"
                              placeholder="Describe your ideal role and what matters to you. For example:&#10;- Role type: data analyst, BI engineer, or analytics engineer&#10;- Salary range: £50,000–£70,000&#10;- Remote: fully remote preferred, open to hybrid&#10;- Industry: open to any, prefer fintech or SaaS&#10;- Contract type: permanent only&#10;- Location: UK-based or anywhere remote&#10;- Not interested in: support roles, junior positions, anything below £45k"></textarea>
                    <div class="form-text">The more specific, the more accurate the match score and recommendation will be.</div>
                </div>

                <!-- Extra Context -->
                <div class="mb-1">
                    <label for="promptExtraContext" class="form-label fw-semibold">
                        <i class="bi bi-chat-left-dots me-1 text-secondary"></i> Extra Context
                        <span class="text-muted fw-normal small ms-1">(optional)</span>
                    </label>
                    <textarea class="form-control" id="promptExtraContext" rows="4"
                              placeholder="Additional detail that helps the AI assess the match. For example:&#10;- I have strong working knowledge of X but it's not listed on my CV&#10;- I have Y years of hands-on experience with Z technology&#10;- I am comfortable working in fast-paced, ambiguous environments&#10;- I have domain experience in finance, healthcare, e-commerce (etc.)&#10;- I prefer roles where I own the full pipeline end-to-end&#10;- I am not interested in roles that are purely reporting/dashboarding with no engineering&#10;- I am open to roles that require upskilling in X&#10;- Notice period: X weeks"></textarea>
                    <div class="form-text">Unlisted skills, domain experience, working style, deal-breakers, or anything that helps the AI judge the fit more accurately.</div>
                </div>

            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="promptSaveBtn" onclick="savePrompt()">
                    <i class="bi bi-check-lg me-1"></i> Save Prompt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ── Delete Confirmation Modal ─────────────────────────────── -->
<div class="modal fade" id="promptDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Delete Prompt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-0">Are you sure you want to delete <strong id="deletePromptName"></strong>? This cannot be undone.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="promptDeleteConfirmBtn" onclick="confirmDeletePrompt()">
                    <i class="bi bi-trash me-1"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ── State ──────────────────────────────────────────────────────
let _editingPromptId = null;
let _deletingPromptId = null;
let _promptEditorModal = null;
let _promptDeleteModal = null;
let _cachedModels = null;  // null = not yet fetched; [] = fetched but Ollama offline

document.addEventListener('DOMContentLoaded', () => {
    _promptEditorModal = new bootstrap.Modal(document.getElementById('promptEditorModal'));
    _promptDeleteModal = new bootstrap.Modal(document.getElementById('promptDeleteModal'));

    document.getElementById('newPromptBtn').addEventListener('click', () => openPromptEditor());

    // Live character count for CV field
    document.getElementById('promptCV').addEventListener('input', updateCvCharCount);

    loadPrompts();
});

function updateCvCharCount() {
    const len = document.getElementById('promptCV').value.length;
    document.getElementById('cvCharCount').textContent = len.toLocaleString() + ' chars';
}

// ── Model loader ────────────────────────────────────────────────
// _cachedModels now stores the full API response object, not just a list.
async function loadOllamaModels(forceRefresh = false, preselectModel = '') {
    const select     = document.getElementById('promptModel');
    const statusEl   = document.getElementById('modelFetchStatus');
    const refreshBtn = document.getElementById('refreshModelsBtn');

    if (_cachedModels !== null && !forceRefresh) {
        populateModelSelect(select, statusEl, _cachedModels, preselectModel);
        return;
    }

    select.innerHTML = '<option value="" disabled selected>Loading…</option>';
    statusEl.textContent = '';
    refreshBtn.disabled = true;

    try {
        const resp = await fetch('/api/ollama/models');
        const data = await resp.json();
        _cachedModels = data;   // cache full response

        const localModels  = data.local_models  || [];
        const cloudModels  = data.cloud_models  || [];
        const hasLocal     = localModels.length > 0;
        const hasCloud     = cloudModels.length > 0;

        if (!data.available && !hasCloud) {
            // Ollama offline and no cloud models configured — fall back to text input
            statusEl.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Ollama not reachable — type a model name manually.</span>';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.id = 'promptModel';
            input.placeholder = 'e.g. llama3.1';
            input.value = preselectModel;
            select.replaceWith(input);
        } else {
            populateModelSelect(select, statusEl, data, preselectModel);
        }
    } catch (err) {
        statusEl.innerHTML = `<span class="text-danger">Failed to fetch models: ${err.message}</span>`;
        select.innerHTML = '<option value="" disabled selected>Error loading models</option>';
    } finally {
        refreshBtn.disabled = false;
    }
}

function populateModelSelect(select, statusEl, data, preselectModel) {
    const localModels = data.local_models || [];
    const owuiModels  = data.owui_models  || [];
    const cloudModels = data.cloud_models || [];

    // Open WebUI model values are stored with an 'owui:' prefix so the
    // backend knows to route them through Open WebUI instead of Ollama.
    const OWUI_PREFIX = 'owui:';

    // Collect all known stored values for the "saved but not in list" fallback
    const allIds = new Set([
        ...localModels,
        ...owuiModels.map(m => OWUI_PREFIX + m.id),
        ...cloudModels.map(m => m.id),
    ]);

    select.innerHTML = '<option value="" disabled>Select a model…</option>';

    // ── Local (Ollama) group ──────────────────────────────────
    if (localModels.length > 0) {
        const grp = document.createElement('optgroup');
        grp.label = 'Local — Ollama (free)';
        localModels.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            if (name === preselectModel) opt.selected = true;
            grp.appendChild(opt);
        });
        select.appendChild(grp);
    } else if (!data.available) {
        const grp = document.createElement('optgroup');
        grp.label = 'Local — Ollama (offline)';
        grp.disabled = true;
        select.appendChild(grp);
    }

    // ── Open WebUI group (Gemini, Claude, etc. via Open WebUI) ─
    if (owuiModels.length > 0) {
        const grp = document.createElement('optgroup');
        grp.label = 'Open WebUI — via gateway ($)';
        owuiModels.forEach(m => {
            const opt = document.createElement('option');
            opt.value = OWUI_PREFIX + m.id;   // sentinel so backend routes correctly
            opt.textContent = `$ ${m.label}`;
            opt.title = `Routed through Open WebUI (${m.id})`;
            if ((OWUI_PREFIX + m.id) === preselectModel) opt.selected = true;
            grp.appendChild(opt);
        });
        select.appendChild(grp);
    }

    // ── Direct cloud APIs group ───────────────────────────────
    if (cloudModels.length > 0) {
        const grp = document.createElement('optgroup');
        grp.label = 'Cloud — direct API ($)';
        cloudModels.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            const keyWarning = m.has_key ? '' : ' ⚠ no API key';
            opt.textContent = `$ ${m.label}${keyWarning}`;
            opt.title = m.has_key
                ? `${m.provider} — direct API call`
                : `${m.provider} — set ${m.provider.toUpperCase().replace('GOOGLE', 'GOOGLE_AI')}_API_KEY in .env`;
            if (m.id === preselectModel) opt.selected = true;
            grp.appendChild(opt);
        });
        select.appendChild(grp);
    }

    // ── Saved value not in any known list ─────────────────────
    if (preselectModel && !allIds.has(preselectModel)) {
        const opt = document.createElement('option');
        opt.value = preselectModel;
        opt.textContent = preselectModel + ' (saved)';
        opt.selected = true;
        select.insertBefore(opt, select.options[1]);
    }

    if (!preselectModel) select.selectedIndex = 0;

    const parts = [];
    if (localModels.length)  parts.push(`${localModels.length} local`);
    if (owuiModels.length)   parts.push(`${owuiModels.length} via Open WebUI`);
    if (cloudModels.length)  parts.push(`${cloudModels.length} cloud`);
    statusEl.textContent = parts.join(', ');
}

// ── Open editor ────────────────────────────────────────────────
function openPromptEditor(promptId = null) {
    _editingPromptId = promptId;

    // Reset form
    document.getElementById('promptTitle').value = '';
    document.getElementById('promptCV').value = '';
    document.getElementById('promptAboutMe').value = '';
    document.getElementById('promptPreferences').value = '';
    document.getElementById('promptExtraContext').value = '';
    document.getElementById('promptIsActive').checked = false;
    updateCvCharCount();

    document.getElementById('promptEditorTitle').textContent = promptId ? 'Edit AI Prompt' : 'New AI Prompt';

    if (promptId) {
        fetch(`/api/ai-prompts/${promptId}`)
            .then(r => r.json())
            .then(p => {
                document.getElementById('promptTitle').value = p.title || '';
                document.getElementById('promptCV').value = p.cv || '';
                document.getElementById('promptAboutMe').value = p.about_me || '';
                document.getElementById('promptPreferences').value = p.preferences || '';
                document.getElementById('promptExtraContext').value = p.extra_context || '';
                document.getElementById('promptIsActive').checked = p.is_active == 1 || p.is_active === true;
                updateCvCharCount();
                // Load models and pre-select the saved one
                loadOllamaModels(false, p.model || '');
            })
            .catch(err => showToast('Failed to load prompt: ' + err.message, 'danger'));
    } else {
        loadOllamaModels(false, '');
    }

    _promptEditorModal.show();
    setTimeout(() => document.getElementById('promptTitle').focus(), 300);
}

// ── Save ───────────────────────────────────────────────────────
async function savePrompt() {
    const title        = document.getElementById('promptTitle').value.trim();
    const modelEl      = document.getElementById('promptModel');
    const model        = modelEl ? modelEl.value.trim() : '';
    const cv           = document.getElementById('promptCV').value.trim();
    const about_me     = document.getElementById('promptAboutMe').value.trim();
    const preferences  = document.getElementById('promptPreferences').value.trim();
    const extra_context = document.getElementById('promptExtraContext').value.trim();
    const is_active    = document.getElementById('promptIsActive').checked;

    if (!title) {
        showToast('Please enter a prompt name', 'warning');
        document.getElementById('promptTitle').focus();
        return;
    }
    if (!model) {
        showToast('Please select an Ollama model', 'warning');
        modelEl && modelEl.focus();
        return;
    }

    const btn = document.getElementById('promptSaveBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';

    try {
        const url    = _editingPromptId ? `/api/ai-prompts/${_editingPromptId}` : '/api/ai-prompts';
        const method = _editingPromptId ? 'PUT' : 'POST';

        const resp = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, model, cv, about_me, preferences, extra_context, is_active }),
        });
        const data = await resp.json();

        if (data.error) { showToast(data.error, 'danger'); return; }

        showToast(_editingPromptId ? 'Prompt updated' : 'Prompt created', 'success');
        _promptEditorModal.hide();
        loadPrompts();
    } catch (err) {
        showToast('Failed to save prompt: ' + err.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Save Prompt';
    }
}

// ── Activate ───────────────────────────────────────────────────
async function activatePrompt(promptId) {
    try {
        const resp = await fetch(`/api/ai-prompts/${promptId}/activate`, { method: 'POST' });
        const data = await resp.json();
        if (data.error) { showToast(data.error, 'danger'); return; }
        showToast('Active prompt updated', 'success');
        loadPrompts();
    } catch (err) {
        showToast('Failed to activate prompt: ' + err.message, 'danger');
    }
}

// ── Delete ─────────────────────────────────────────────────────
function promptDeletePrompt(promptId, title) {
    _deletingPromptId = promptId;
    document.getElementById('deletePromptName').textContent = '"' + title + '"';
    _promptDeleteModal.show();
}

async function confirmDeletePrompt() {
    if (!_deletingPromptId) return;

    const btn = document.getElementById('promptDeleteConfirmBtn');
    btn.disabled = true;

    try {
        const resp = await fetch(`/api/ai-prompts/${_deletingPromptId}`, { method: 'DELETE' });
        const data = await resp.json();
        if (data.error) { showToast(data.error, 'danger'); return; }
        showToast('Prompt deleted', 'info');
        _promptDeleteModal.hide();
        loadPrompts();
    } catch (err) {
        showToast('Failed to delete prompt: ' + err.message, 'danger');
    } finally {
        btn.disabled = false;
        _deletingPromptId = null;
    }
}

// ── Load & render ──────────────────────────────────────────────
async function loadPrompts() {
    const listEl    = document.getElementById('promptsList');
    const loadingEl = document.getElementById('promptsLoading');
    const emptyEl   = document.getElementById('promptsEmpty');

    listEl.innerHTML = '';
    loadingEl.style.display = 'block';
    emptyEl.style.display   = 'none';

    try {
        const resp = await fetch('/api/ai-prompts');
        const data = await resp.json();

        loadingEl.style.display = 'none';

        if (!data.prompts || data.prompts.length === 0) {
            emptyEl.style.display = 'block';
            document.getElementById('totalPrompts').textContent = '0';
            return;
        }

        document.getElementById('totalPrompts').textContent = data.total;

        data.prompts.forEach((prompt, idx) => {
            listEl.innerHTML += renderPromptCard(prompt, idx);
        });
    } catch (err) {
        loadingEl.style.display = 'none';
        listEl.innerHTML = `<div class="col-12"><div class="alert alert-danger">Failed to load prompts: ${err.message}</div></div>`;
    }
}

function renderPromptCard(p, idx) {
    const isActive   = p.is_active == 1 || p.is_active === true || p.is_active === '1';
    const cvLen      = (p.cv || '').length;
    const cvPreview  = cvLen > 0 ? `${cvLen.toLocaleString()} chars pasted` : '<span class="text-muted fst-italic">No CV pasted</span>';
    const updatedAt  = formatDate(p.updated_at || p.created_at);

    const activeBadge = isActive
        ? `<span class="badge bg-success ms-2"><i class="bi bi-check-circle me-1"></i>Active</span>`
        : '';

    const activateBtn = !isActive
        ? `<button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); activatePrompt(${p.id})" title="Set as active prompt">
               <i class="bi bi-check-circle me-1"></i>Set Active
           </button>`
        : `<button class="btn btn-sm btn-success disabled" disabled>
               <i class="bi bi-check-circle-fill me-1"></i>Active
           </button>`;

    // Build a compact summary of what's filled in
    const fields = [
        { label: 'Model',        value: p.model        ? `<span class="badge bg-info text-dark font-monospace">${escapeHtml(p.model)}</span>` : '<span class="text-muted fst-italic">—</span>' },
        { label: 'CV',           value: cvPreview },
        { label: 'About Me',     value: p.about_me     ? truncate(p.about_me, 80)     : '<span class="text-muted fst-italic">—</span>' },
        { label: 'Preferences',  value: p.preferences  ? truncate(p.preferences, 80)  : '<span class="text-muted fst-italic">—</span>' },
        { label: 'Extra Context',value: p.extra_context? truncate(p.extra_context, 80): '<span class="text-muted fst-italic">—</span>' },
    ];

    const fieldRows = fields.map(f =>
        `<tr>
            <td class="text-muted small pe-2 text-nowrap" style="width:110px;">${f.label}</td>
            <td class="small">${f.value}</td>
        </tr>`
    ).join('');

    return `
    <div class="col-12 col-lg-6 fade-in" style="animation-delay: ${idx * 0.04}s">
        <div class="note-card ${isActive ? 'border border-success border-opacity-50' : ''}">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <span class="fw-bold">${escapeHtml(p.title)}</span>${activeBadge}
                </div>
                <div class="d-flex gap-1 flex-shrink-0 ms-2">
                    <button class="action-btn" onclick="openPromptEditor(${p.id})" title="Edit prompt">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="action-btn note-delete-btn" onclick="promptDeletePrompt(${p.id}, ${JSON.stringify(p.title)})" title="Delete prompt">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>

            <table class="table table-borderless table-sm mb-2" style="margin-bottom:0.25rem!important;">
                <tbody>${fieldRows}</tbody>
            </table>

            <div class="d-flex justify-content-between align-items-center mt-2">
                <span class="note-card-meta"><i class="bi bi-clock me-1"></i>${updatedAt}</span>
                ${activateBtn}
            </div>
        </div>
    </div>`;
}

function truncate(str, maxLen) {
    if (!str) return '';
    const clean = str.replace(/\n/g, ' ').trim();
    return escapeHtml(clean.length > maxLen ? clean.substring(0, maxLen) + '…' : clean);
}

// ── Analysis Queue UI ─────────────────────────────────────────
let _sortable = null;

/** Re-render the queue section from the AIQueue state snapshot. */
function renderQueue(state) {
    const section     = document.getElementById('queueSection');
    const runningRow  = document.getElementById('queueRunningRow');
    const runTitle    = document.getElementById('queueRunningTitle');
    const runModel    = document.getElementById('queueRunningModel');
    const runPrompt   = document.getElementById('queueRunningPrompt');
    const listEl      = document.getElementById('queueItemsList');
    const totalBadge  = document.getElementById('queueTotalBadge');

    if (!section) return;

    const total = (state.running ? 1 : 0) + state.queue.length;
    section.style.display = total > 0 ? '' : 'none';

    if (totalBadge) totalBadge.textContent = `${total} item${total !== 1 ? 's' : ''}`;

    // ── Running item ─────────────────────────────────────────
    if (state.running) {
        runningRow.style.display = 'flex';
        if (runTitle)  runTitle.textContent  = state.running.jobTitle   || '';
        if (runModel)  runModel.textContent  = state.running.model      || '';
        if (runPrompt) runPrompt.textContent = state.running.promptTitle || '';
    } else {
        runningRow.style.display = 'none';
    }

    // ── Queue items ──────────────────────────────────────────
    // Tear down the old Sortable instance before rebuilding the DOM
    if (_sortable) { _sortable.destroy(); _sortable = null; }
    listEl.innerHTML = '';

    state.queue.forEach((item) => {
        const div = document.createElement('div');
        div.className   = 'queue-item d-flex align-items-center gap-2 p-2 mb-2 rounded border';
        div.dataset.jobId    = item.jobId;
        div.dataset.promptId = item.promptId;
        div.innerHTML = `
            <span class="drag-handle text-muted px-1" style="cursor:grab;" title="Drag to reorder">
                <i class="bi bi-grip-vertical"></i>
            </span>
            <div class="flex-grow-1 small overflow-hidden">
                <div class="fw-semibold text-truncate">${escapeHtml(item.jobTitle)}</div>
                <span class="badge bg-info text-dark font-monospace">${escapeHtml(item.model || '?')}</span>
                <span class="text-muted ms-1">${escapeHtml(item.promptTitle || '')}</span>
            </div>
            <button class="btn btn-sm btn-outline-danger py-0 px-2 flex-shrink-0"
                    data-job-id="${escapeHtml(item.jobId)}"
                    data-prompt-id="${item.promptId}"
                    title="Remove from queue">
                <i class="bi bi-x-lg"></i>
            </button>`;

        // Remove button click
        div.querySelector('button').addEventListener('click', () => {
            AIQueue.remove(item.jobId, item.promptId);
        });

        listEl.appendChild(div);
    });

    // Attach Sortable when there are items to sort
    if (state.queue.length > 1) {
        _sortable = Sortable.create(listEl, {
            handle:    '.drag-handle',
            animation: 150,
            ghostClass: 'opacity-50',
            onEnd() {
                // Read new order from DOM and push back to AIQueue
                const pairs = [...listEl.querySelectorAll('.queue-item')].map(el => ({
                    jobId:    el.dataset.jobId,
                    promptId: parseInt(el.dataset.promptId),
                }));
                AIQueue.reorderByIds(pairs);
            },
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Render immediately with whatever is already in the queue (page might
    // have been navigated to mid-queue from another tab).
    renderQueue(AIQueue.getState());
});

// Re-render whenever the queue changes (dispatched by ai_analyse.js)
document.addEventListener('aiqueue:update', (e) => renderQueue(e.detail));
</script>
{% endblock %}
